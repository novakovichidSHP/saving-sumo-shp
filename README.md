# sumo_fix_pipeline.py

Скрипт для пакетной и одиночной обработки файлов Sumo3D (.sumo):
- Исправляет типы геометрии (BoxBufferGeometry → BoxGeometry и т.д.)
- Удаляет из JSON все строки, связанные с sumo.app/api/auth/check (CORS/авторизация)
- **Автоматически переконвертирует все встроенные base64-изображения jpeg/jpg в png**
- Собирает обратно исправленный .sumo-файл

## Требования
- Python 3.7+
- git pus (обычно входит в стандартную поставку Python)
- Pillow (`pip install pillow`)

## requirements.txt
```
tk
pillow
```

## Как использовать

1. Запусти скрипт:
   ```
   python sumo_fix_pipeline.py
   ```
2. Появится окно с вопросом:
   - **"Обработать ОДИН файл? (Нет = выбрать папку)"**
   - Если выберешь "Да" — откроется диалог выбора одного .sumo-файла.
   - Если выберешь "Нет" — откроется диалог выбора папки. Все .sumo-файлы в этой папке будут обработаны.

3. После обработки:
   - Для одиночного файла результат будет сохранён рядом с исходным, с суффиксом `_fixed.sumo`.
   - Для папки все исправленные файлы будут помещены в подпапку `fixed` внутри выбранной папки, с суффиксом `_fixed.sumo`.

4. После завершения появится окно с уведомлением о результате.

---

## Полный алгоритм обработки и исправления .sumo-файлов

1. **Выбор режима работы**
   - При запуске скрипта появляется окно с вопросом: обработать один файл или всю папку.
   - Если выбран один файл — открывается диалог выбора .sumo-файла.
   - Если выбрана папка — открывается диалог выбора папки, в которой будут обработаны все .sumo-файлы верхнего уровня.

2. **Распаковка .sumo-файла**
   - .sumo — это zip-архив, внутри которого обязательно есть файл `data.txt` (JSON-описание сцены).
   - Скрипт извлекает `data.txt` и все остальные ресурсы (если есть).

3. **Чтение и парсинг JSON**
   - Содержимое `data.txt` читается как текст.
   - Проводится попытка распарсить содержимое как JSON.
   - Если JSON невалиден (например, из-за бинарных данных вместо base64-строк), скрипт сообщает об ошибке и пропускает файл.

4. **Исправление типов геометрии**
   - В JSON ищутся все объекты с типами, заканчивающимися на `BufferGeometry` (например, `BoxBufferGeometry`).
   - Все такие типы заменяются на соответствующие обычные типы (`BoxGeometry`, `SphereGeometry` и т.д.), чтобы обеспечить совместимость с Sumo3D.

5. **Удаление лишних строк авторизации**
   - Из JSON удаляются все строки, содержащие `sumo.app/api/auth/check` (устранение CORS/авторизации).

6. **Поиск и обработка встроенных изображений**
   - В JSON ищутся все строки, начинающиеся с `data:image/` (base64-встраивание).
   - Для каждого такого изображения:
     - Определяется формат (jpeg, jpg, png и т.д.).
     - Если это jpeg/jpg:
       - Декодируется base64-строка в бинарные данные.
       - С помощью Pillow изображение перекодируется в PNG.
       - Полученное PNG-изображение снова кодируется в base64.
       - В JSON заменяется строка на новую: `data:image/png;base64,...`
     - Если это уже PNG — изображение не трогается.
     - Если формат неизвестен или не поддерживается — логируется предупреждение.
   - Если base64-строка невалидна или не декодируется — логируется ошибка, изображение пропускается.

7. **Сборка исправленного JSON**
   - После всех замен и исправлений формируется новый JSON.
   - Проверяется его валидность (можно добавить строгую валидацию как TODO).

8. **Сборка нового .sumo-файла**
   - В архив добавляется исправленный `data.txt`.
   - Все остальные ресурсы из исходного архива (если были) также копируются без изменений.
   - Новый архив сохраняется с суффиксом `_fixed.sumo`:
     - Для одиночного файла — рядом с исходным.
     - Для папки — в подпапке `fixed`.

9. **Завершение и уведомление**
   - После обработки появляется окно с уведомлением о результате (сколько файлов обработано, были ли ошибки).
   - Оригинальные файлы не изменяются.

---

### Важные детали и проверки

- Скрипт не обрабатывает подпапки (только верхний уровень выбранной папки).
- Все операции с изображениями выполняются только в памяти, без временных файлов.
- Если в исходном JSON были невалидные base64-строки или бинарные данные, такие изображения могут быть пропущены или вызвать ошибку.
- Все найденные и обработанные ошибки логируются (можно доработать логирование в отдельный файл).
- Итоговый .sumo-файл должен открываться на сайте Sumo3D без ошибок (но это не гарантируется автоматически — см. раздел TODO).

## Пример запуска
```
python sumo_fix_pipeline.py
```

## Примечания
- Скрипт не обрабатывает подпапки внутри выбранной папки (только файлы верхнего уровня).
- Оригинальные файлы не изменяются.
- Для работы нужен Python с поддержкой tkinter и Pillow.

---

## Известные проблемы
- Иногда в data.txt вместо base64-строки изображения может попасть бинарный мусор, что делает JSON невалидным и вызывает ошибку при открытии файла на сайте Sumo3D.
- Некоторые изображения, даже после перекодирования, могут не открываться в WebGL на сайте Sumo3D (ошибка "image could not be decoded").
- Если в data.txt уже была невалидная base64-строка, скрипт может не восстановить её корректно.
- Не все форматы изображений корректно определяются и перекодируются (например, редкие форматы или повреждённые данные).
- Нет строгой валидации, что после обработки все изображения действительно открываются как PNG.
- Нет автоматического теста на валидность итогового data.txt (JSON + base64).
- Нет логирования с сохранением отчёта о проблемных файлах/изображениях.

## TODO
- Добавить строгую валидацию: после обработки проверять, что все изображения в JSON — корректные base64 PNG, и что JSON валиден.
- Добавить автоматическую проверку валидности итогового .sumo-файла (можно ли открыть на сайте Sumo3D).
- Реализовать логирование ошибок с сохранением отчёта (какие изображения/файлы не удалось обработать).
- Добавить опцию "только проверить" без изменений — для диагностики.
- Сделать CLI-режим без GUI для пакетной обработки на сервере.
- Добавить обработку подпапок (рекурсивно).
- Добавить тесты для разных кейсов (валидные/невалидные изображения, разные форматы, большие файлы).
- Улучшить обработку редких/нестандартных форматов изображений.
- Добавить опцию автоматического резервного копирования исходных файлов.

---

**Если нужна доработка — пиши!** 