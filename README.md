# Обработка .sumo-файлов для Sumo3D

Скрипты для пакетной и одиночной обработки файлов Sumo3D (.sumo):
- Исправляют типы геометрии (BoxBufferGeometry → BoxGeometry и т.д.)
- Удаляют из JSON все строки, связанные с sumo.app/api/auth/check (CORS/авторизация)
- **Автоматически переконвертируют все встроенные base64-изображения jpeg/jpg в png** (только полная версия)
- Собирают обратно исправленный .sumo-файл

---

## Быстрый старт

1. Запустите нужный скрипт (см. ниже про версии).
2. Выберите файл или папку с .sumo-файлами.
3. Дождитесь завершения обработки. Результаты будут в той же папке (или в подпапке `fixed`).

---

## Версии скриптов

### 1. Полная версия (с Pillow)
- **Файл:** `sumo_fix_pipeline.py`
- Требует: Python 3.x, библиотеки `pillow`, `tkinter`
- Умеет перекодировать встроенные изображения в PNG для максимальной совместимости с Sumo3D

### 2. Облегчённая версия (без Pillow)
- **Файл:** `sumo_fix_pipeline_no_pillow.py`
- Требует только стандартный Python 3.x и tkinter (обычно есть по умолчанию)
- Не перекодирует изображения, а только проверяет корректность base64-строк
- Рекомендуется для быстрой пакетной обработки, если не требуется перекодирование картинок

---

## Сборка exe-файла

Для Windows можно собрать самостоятельный exe-файл (не требует Python на целевом ПК):

1. Установите pyinstaller:
   ```
   pip install pyinstaller
   ```
2. Соберите exe (для полной или облегчённой версии):
   - Для полной:
     ```
     pyinstaller --onefile --noconsole sumo_fix_pipeline.py
     ```
   - Для облегчённой:
     ```
     pyinstaller --onefile --noconsole sumo_fix_pipeline_no_pillow.py
     ```
3. Готовый exe появится в папке `dist`.

---

## Подробный алгоритм работы

1. **Выбор режима работы**
   - При запуске появляется окно: обработать один файл или всю папку.
   - Если выбран один файл — откроется диалог выбора .sumo-файла.
   - Если выбрана папка — откроется диалог выбора папки, в которой будут обработаны все .sumo-файлы верхнего уровня.

2. **Распаковка .sumo-файла**
   - .sumo — это zip-архив, внутри которого обязательно есть файл `data.txt` (JSON-описание сцены).
   - Скрипт извлекает `data.txt` и все остальные ресурсы (если есть).

3. **Чтение и парсинг JSON**
   - Содержимое `data.txt` читается как текст.
   - Проводится попытка распарсить содержимое как JSON.
   - Если JSON невалиден (например, из-за бинарных данных вместо base64-строк), скрипт сообщает об ошибке и пропускает файл.

4. **Исправление типов геометрии**
   - В JSON ищутся все объекты с типами, заканчивающимися на `BufferGeometry` (например, `BoxBufferGeometry`).
   - Все такие типы заменяются на соответствующие обычные типы (`BoxGeometry`, `SphereGeometry` и т.д.), чтобы обеспечить совместимость с Sumo3D.

5. **Удаление лишних строк авторизации**
   - Из JSON удаляются все строки, содержащие `sumo.app/api/auth/check` (устранение CORS/авторизации).

6. **Поиск и обработка встроенных изображений**
   - В JSON ищутся все строки, начинающиеся с `data:image/` (base64-встраивание).
   - Для каждого такого изображения:
     - Определяется формат (jpeg, jpg, png и т.д.).
     - Если это jpeg/jpg (только полная версия):
       - Декодируется base64-строка в бинарные данные.
       - С помощью Pillow изображение перекодируется в PNG.
       - Полученное PNG-изображение снова кодируется в base64.
       - В JSON заменяется строка на новую: `data:image/png;base64,...`
     - Если это уже PNG — изображение не трогается.
     - Если формат неизвестен или не поддерживается — логируется предупреждение.
   - Если base64-строка невалидна или не декодируется — логируется ошибка, изображение пропускается.
   - **В облегчённой версии**: только проверяется, что base64-строка декодируется, перекодирования нет.

7. **Сборка исправленного JSON**
   - После всех замен и исправлений формируется новый JSON.
   - Проверяется его валидность (можно добавить строгую валидацию как TODO).

8. **Сборка нового .sumo-файла**
   - В архив добавляется исправленный `data.txt`.
   - Все остальные ресурсы из исходного архива (если были) также копируются без изменений.
   - Новый архив сохраняется с суффиксом `_fixed.sumo`:
     - Для одиночного файла — рядом с исходным.
     - Для папки — в подпапке `fixed`.

9. **Завершение и уведомление**
   - После обработки появляется окно с уведомлением о результате (сколько файлов обработано, были ли ошибки).
   - Оригинальные файлы не изменяются.

---

## Важные детали и проверки

- Скрипт не обрабатывает подпапки (только верхний уровень выбранной папки).
- Все операции с изображениями выполняются только в памяти, без временных файлов.
- Если в исходном JSON были невалидные base64-строки или бинарные данные, такие изображения могут быть пропущены или вызвать ошибку.
- Все найденные и обработанные ошибки логируются (можно доработать логирование в отдельный файл).
- Итоговый .sumo-файл должен открываться на сайте Sumo3D без ошибок (но это не гарантируется автоматически — см. раздел TODO).

---

## Пример запуска
```
python sumo_fix_pipeline.py
```
или для облегчённой версии:
```
python sumo_fix_pipeline_no_pillow.py
```

---

## Известные ограничения
- Иногда изображения внутри data.txt могут быть повреждены или не открываться в WebGL на сайте Sumo3D
- Нет строгой валидации итогового JSON и изображений
- Нет автоматического теста на валидность итогового файла
- Нет логирования с сохранением отчёта о проблемных файлах/изображениях

## TODO
- Добавить строгую валидацию: после обработки проверять, что все изображения в JSON — корректные base64 PNG, и что JSON валиден.
- Добавить автоматическую проверку валидности итогового .sumo-файла (можно ли открыть на сайте Sumo3D).
- Реализовать логирование ошибок с сохранением отчёта (какие изображения/файлы не удалось обработать).
- Добавить опцию "только проверить" без изменений — для диагностики.
- Сделать CLI-режим без GUI для пакетной обработки на сервере.
- Добавить обработку подпапок (рекурсивно).
- Добавить тесты для разных кейсов (валидные/невалидные изображения, разные форматы, большие файлы).
- Улучшить обработку редких/нестандартных форматов изображений.
- Добавить опцию автоматического резервного копирования исходных файлов.

---

**Правки приветствуются!**
