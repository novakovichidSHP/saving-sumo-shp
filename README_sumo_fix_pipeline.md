# sumo_fix_pipeline.py

Скрипт для пакетной и одиночной обработки файлов Sumo3D (.sumo):
- Исправляет типы геометрии (BoxBufferGeometry → BoxGeometry и т.д.)
- Удаляет из JSON все строки, связанные с sumo.app/api/auth/check (CORS/авторизация)
- **Автоматически переконвертирует все встроенные base64-изображения jpeg/jpg в png**
- Собирает обратно исправленный .sumo-файл

## Требования
- Python 3.7+
- tkinter (обычно входит в стандартную поставку Python)
- Pillow (`pip install pillow`)

## requirements.txt
```
tk
pillow
```

## Как использовать

1. Запусти скрипт:
   ```
   python sumo_fix_pipeline.py
   ```
2. Появится окно с вопросом:
   - **"Обработать ОДИН файл? (Нет = выбрать папку)"**
   - Если выберешь "Да" — откроется диалог выбора одного .sumo-файла.
   - Если выберешь "Нет" — откроется диалог выбора папки. Все .sumo-файлы в этой папке будут обработаны.

3. После обработки:
   - Для одиночного файла результат будет сохранён рядом с исходным, с суффиксом `_fixed.sumo`.
   - Для папки все исправленные файлы будут помещены в подпапку `fixed` внутри выбранной папки, с суффиксом `_fixed.sumo`.

4. После завершения появится окно с уведомлением о результате.

## Что делает скрипт
- Распаковывает .sumo-файл (это zip-архив с data.txt)
- Преобразует data.txt (JSON):
  - Исправляет типы геометрии на совместимые с Sumo3D
  - Удаляет все строки, содержащие `sumo.app/api/auth/check`
  - **Находит все встроенные изображения jpeg/jpg (base64) и перекодирует их в png (base64)**
- Собирает обратно исправленный .sumo-файл (сохраняя все ресурсы)

## Пример запуска
```
python sumo_fix_pipeline.py
```

## Примечания
- Скрипт не обрабатывает подпапки внутри выбранной папки (только файлы верхнего уровня).
- Оригинальные файлы не изменяются.
- Для работы нужен Python с поддержкой tkinter и Pillow.

---

## Известные проблемы
- Иногда в data.txt вместо base64-строки изображения может попасть бинарный мусор, что делает JSON невалидным и вызывает ошибку при открытии файла на сайте Sumo3D.
- Некоторые изображения, даже после перекодирования, могут не открываться в WebGL на сайте Sumo3D (ошибка "image could not be decoded").
- Если в data.txt уже была невалидная base64-строка, скрипт может не восстановить её корректно.
- Не все форматы изображений корректно определяются и перекодируются (например, редкие форматы или повреждённые данные).
- Нет строгой валидации, что после обработки все изображения действительно открываются как PNG.
- Нет автоматического теста на валидность итогового data.txt (JSON + base64).
- Нет логирования с сохранением отчёта о проблемных файлах/изображениях.

## TODO
- Добавить строгую валидацию: после обработки проверять, что все изображения в JSON — корректные base64 PNG, и что JSON валиден.
- Добавить автоматическую проверку валидности итогового .sumo-файла (можно ли открыть на сайте Sumo3D).
- Реализовать логирование ошибок с сохранением отчёта (какие изображения/файлы не удалось обработать).
- Добавить опцию "только проверить" без изменений — для диагностики.
- Сделать CLI-режим без GUI для пакетной обработки на сервере.
- Добавить обработку подпапок (рекурсивно).
- Добавить тесты для разных кейсов (валидные/невалидные изображения, разные форматы, большие файлы).
- Улучшить обработку редких/нестандартных форматов изображений.
- Добавить опцию автоматического резервного копирования исходных файлов.

---

**Если нужна доработка — пиши!** 